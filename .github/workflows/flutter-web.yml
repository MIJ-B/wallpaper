name: Flutter Web Deploy

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  REPO_NAME: wallpaper
  USERNAME: MIJ-B

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
    
    - name: Generate index.html
      run: |
        mkdir -p web
        cat > web/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <base href="$FLUTTER_BASE_HREF">
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
          <meta name="apple-mobile-web-app-capable" content="yes">
          <meta name="apple-mobile-web-app-status-bar-style" content="black">
          <meta name="theme-color" content="#000000">
          <title>Skeleton Bibilava</title>
          <link rel="manifest" href="manifest.json">
          <style>
            * {
              margin: 0;
              padding: 0;
              box-sizing: border-box;
            }
            body {
              margin: 0;
              padding: 0;
              background: #000;
              overflow: hidden;
              width: 100vw;
              height: 100vh;
              touch-action: none;
              -webkit-user-select: none;
              user-select: none;
            }
            #loading {
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              height: 100vh;
              background: #000;
              color: #fff;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            }
            .spinner {
              width: 50px;
              height: 50px;
              border: 4px solid rgba(255, 255, 255, 0.1);
              border-top-color: #fff;
              border-radius: 50%;
              animation: spin 1s linear infinite;
              margin-bottom: 20px;
            }
            @keyframes spin {
              to { transform: rotate(360deg); }
            }
            .loading-text {
              font-size: 18px;
              letter-spacing: 1px;
            }
            flt-glass-pane {
              position: absolute !important;
              top: 0 !important;
              left: 0 !important;
              width: 100% !important;
              height: 100% !important;
            }
          </style>
        </head>
        <body>
          <div id="loading">
            <div class="spinner"></div>
            <div class="loading-text">Loading Skeleton...</div>
          </div>
          <script>
            var serviceWorkerVersion = null;
            var scriptLoaded = false;
            
            function loadMainDartJs() {
              if (scriptLoaded) return;
              scriptLoaded = true;
              
              if (typeof _flutter !== 'undefined' && _flutter.loader) {
                _flutter.loader.loadEntrypoint({
                  serviceWorker: {
                    serviceWorkerVersion: serviceWorkerVersion,
                  },
                  onEntrypointLoaded: function(engineInitializer) {
                    engineInitializer.initializeEngine().then(function(appRunner) {
                      appRunner.runApp();
                      setTimeout(function() {
                        var loadingDiv = document.getElementById('loading');
                        if (loadingDiv) {
                          loadingDiv.style.display = 'none';
                        }
                      }, 500);
                    });
                  }
                });
              }
            }
            
            window.addEventListener('load', function() {
              loadMainDartJs();
            });
            
            // Fallback if flutter.js is already loaded
            if (typeof _flutter !== 'undefined') {
              loadMainDartJs();
            }
          </script>
          <script src="flutter.js" defer></script>
        </body>
        </html>
        EOF
    
    - name: Generate manifest.json
      run: |
        cat > web/manifest.json << 'EOF'
        {
          "name": "Skeleton Bibilava",
          "short_name": "Skeleton",
          "start_url": ".",
          "display": "fullscreen",
          "background_color": "#000000",
          "theme_color": "#000000",
          "description": "Interactive skeleton animation",
          "orientation": "any",
          "prefer_related_applications": false,
          "icons": []
        }
        EOF
    
    - name: Get dependencies
      run: flutter pub get
    
    - name: Run tests
      run: flutter test
      continue-on-error: true
    
    - name: Build web
      run: flutter build web --release --base-href /${{ env.REPO_NAME }}/
    
    - name: Add custom 404 page
      run: |
        cp build/web/index.html build/web/404.html
    
    - name: Create .nojekyll file
      run: |
        touch build/web/.nojekyll
    
    - name: Deploy to GitHub Pages
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./build/web
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸ¦´ Deploy Skeleton Bibilava'